# 멀티 에이전트 시스템 구축 가이드

## 개요
Antigravity + OpenAI Codex + Gemini CLI를 연결한 멀티 에이전트 시스템 구축 방법 정리

---

## 1. API 과금 없이 구독 할당량 활용하기

### 작동 원리
```
┌─────────────────────────────────────────────────────┐
│  사용자 Google 계정 (OAuth 로그인)                    │
│  - Gemini Free Tier (무료 할당량)                    │
│  - 또는 Google AI Pro 구독 ($19.99/월)              │
└─────────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────┐
│  Gemini CLI / oh-my-opencode                       │
│  - API Key 필요 없음                                │
│  - API 과금 없음                                    │
│  - 구독 할당량 사용                                  │
└─────────────────────────────────────────────────────┘
```

### 할당량 비교 (2025년 12월 이후)

| 인증 방식 | 모델 | 일일 요청 | 분당 요청 |
|----------|------|----------|----------|
| OAuth (Gemini CLI) | Pro/Flash Blended | ~1,000 RPD | 60 RPM |
| API Free Tier | 2.5 Flash | ~20 RPD | 제한적 |
| Google AI Pro 구독 | 2.5 Pro | 높음 | 높음 |

---

## 2. 프레임워크 비교

| 프레임워크 | 특징 | 최적 용도 | 토큰 효율성 |
|------------|------|----------|------------|
| **LangGraph** | 그래프 기반, 상태 관리, 정밀 제어 | 복잡한 워크플로우, 미션 크리티컬 시스템 | ⭐⭐⭐ |
| **AutoGen** (Microsoft) | 대화 기반, 코드 생성/실행 | 에이전트 간 토론, 코드 자동화 | ⭐⭐⭐ |
| **CrewAI** | 역할 기반 팀 구성, 빠른 설정 | 빠른 프로토타이핑, 팀 워크플로우 | ⭐⭐⭐⭐ |
| **직접 구축** | 가볍고 완전 커스텀 가능 | 토큰 효율 중시 | ⭐⭐⭐⭐⭐ |

> ⚠️ MCP 방식은 토큰 소모가 빠르므로 패스

---

## 3. 구현 방법

### 옵션 A: Gemini CLI + OAuth 인증

```bash
# Gemini CLI 설치
npm install -g @anthropic-ai/gemini-cli

# OAuth 로그인 (Google 계정)
gemini auth login
# → 브라우저에서 Google 로그인 → 완료
```

### 옵션 B: oh-my-opencode + 플러그인

`opencode-gemini-auth` 플러그인을 사용해서 Google 계정 OAuth 인증으로 Gemini Free Tier나 구독 할당량을 사용

- GitHub: https://github.com/anthropics/opencode-gemini-auth

### 옵션 C: Python 오케스트레이터 (subprocess 호출)

```python
import subprocess

def call_gemini_cli(prompt):
    """Gemini CLI 호출 (OAuth 인증된 상태)"""
    result = subprocess.run(
        ["gemini", "chat", "--prompt", prompt],
        capture_output=True, text=True
    )
    return result.stdout

def call_openai_cli(prompt):
    """OpenAI CLI 호출"""
    result = subprocess.run(
        ["openai-cli", "chat", prompt],
        capture_output=True, text=True
    )
    return result.stdout

class MultiAgentOrchestrator:
    def process(self, task):
        # 1. Gemini가 작업 분석/계획
        plan = call_gemini_cli(f"다음 작업을 분석해줘: {task}")
        
        # 2. OpenAI가 코드 작업
        code = call_openai_cli(f"다음 계획을 코드로 구현해줘: {plan}")
        
        # 3. Gemini가 검토
        review = call_gemini_cli(f"다음 코드를 검토해줘: {code}")
        
        return review
```

---

## 4. 아키텍처 설계

```
┌─────────────────────────────────────────────────────────┐
│                    Antigravity (메인 허브)               │
│                     (현재 환경 - Gemini)                 │
├─────────────────────────────────────────────────────────┤
│                           │                             │
│              ┌────────────┴────────────┐                │
│              ▼                         ▼                │
│   ┌──────────────────┐      ┌──────────────────┐       │
│   │  OpenAI Codex    │      │   Gemini CLI     │       │
│   │  (Agents SDK)    │      │  (OAuth 인증)     │       │
│   │  - 코딩 작업      │      │  - 분석/검토       │       │
│   │  - 코드 리뷰      │      │  - 계획 수립       │       │
│   └──────────────────┘      └──────────────────┘       │
└─────────────────────────────────────────────────────────┘
```

---

## 5. 주의사항

- **Gemini CLI OAuth**: 무료 할당량이 API보다 넉넉함 (60 RPM, 1000 RPD)
- **OpenAI**: ChatGPT Plus 구독과 API 과금은 별도 → OAuth 방식 접근이 제한적
- **Antigravity**: 이미 OAuth 인증을 통해 Gemini 할당량 사용 중
- **토큰 효율**: 직접 구축 방식이 가장 효율적

---

## 6. 다음 단계

1. [ ] Gemini CLI 설치 및 OAuth 인증 테스트
2. [ ] OpenAI CLI 또는 Codex 연동 방법 확인
3. [ ] Python 오케스트레이터 스크립트 작성
4. [ ] 멀티 에이전트 워크플로우 정의
5. [ ] 테스트 및 최적화

---

## 참고 자료

- oh-my-opencode: https://ohmyopencode.com
- Gemini CLI 공식 문서: https://geminicli.com
- OpenAI Agents SDK: https://openai.com/agents
- CrewAI: https://crewai.com
- LangGraph: https://langchain.com/langgraph
- AutoGen: https://microsoft.github.io/autogen

---

## 7. AI 코딩 에이전트 방식 비교

### 7.1 Boris Cherny 방식 (Claude Code 창시자)

Boris Cherny는 Claude Code를 만든 Anthropic 엔지니어. 내부에서 실제로 사용하는 방식.

| 핵심 개념 | 설명 |
|----------|------|
| **피드백 루프** | `/clear` → `/verify` 로 Context Bias 제거 |
| **병렬 개발** | 터미널 5개 + Git Worktree로 동시 작업 |
| **CLAUDE.md** | 실수와 베스트 프랙티스 기록 파일 |
| **품질 향상** | 피드백 루프로 2~3배 품질 향상 |

**워크플로우:**
```
1. 워크트리 생성 → 개발
2. /handoff로 의도 기록
3. /clear로 대화 초기화
4. /verify로 새로운 눈으로 검증
5. 통과 → 커밋 → PR
```

**왜 이렇게 하나?**
- 같은 세션에서 검증하면 자기가 짠 코드라 문제를 못 봄 (Context Bias)
- 대화 지우고 검증하면 이 bias가 사라짐
- Anthropic 신입 온보딩도 이 방식으로 함

---

### 7.2 OhMyOpenCode

| 핵심 개념 | 설명 |
|----------|------|
| **Sisyphus** | 메인 오케스트레이터 (엔지니어링 매니저 역할) |
| **하위 에이전트** | 프론트엔드, 사서, 오라클 등 전문 에이전트 |
| **ultrawork** | 병렬 에이전트, 백그라운드 작업 자동 활성화 |
| **API 필요** | Claude, Gemini, OpenAI 등 여러 API 키 필요 (비용↑) |

**설치:**
```bash
bunx oh-my-opencode install
# 또는
npx oh-my-opencode install
```

---

### 7.3 BMAD (Breakthrough Method for Agile AI-Driven Development)

| 장점 | 단점 |
|------|------|
| 체계적인 Agile 워크플로우 | 간단한 프로젝트에는 과함 (Overkill) |
| 멀티 에이전트 협업 | 학습 곡선 높음 (YAML 설정 복잡) |
| 문서화 자동 생성 | 구조가 너무 rigid함 |
| 무료 오픈소스 | "Vibe Coding" 선호하면 안 맞음 |
| Agent-as-Code 패러다임 | 단일 마이크로서비스 중심 |

> ⚠️ **결론**: BMAD는 추천하지 않음. 간단한 프로젝트에는 과하고 학습 곡선이 높음.

---

### 7.4 방식 비교 요약

| 방식 | 장점 | 단점 | 추천 대상 |
|------|------|------|----------|
| **Boris 방식** | 검증됨, 피드백 루프로 품질↑ | 수동 작업 필요 | 검증된 거 쓰고 싶은 분 |
| **OhMyOpenCode** | 자동화 극대화, 병렬 처리 | API 비용↑ | 자동화 극대화하고 싶은 분 |
| **BMAD** | 체계적 문서화 | 과하고 복잡함 | ❌ 비추천 |

---

## 8. Antigravity에서 피드백 루프 구현

### 8.1 Boris 방식 적용하기

Antigravity에서 Boris 방식의 **피드백 루프**를 이렇게 구현:

```
┌─────────────────────────────────────────────────────┐
│  1단계: 개발 (Antigravity 기본 사용)                  │
│  - 코드 작성                                        │
│  - 파일 편집                                        │
└─────────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────┐
│  2단계: Handoff (의도 기록)                          │
│  - 작업 내용을 HANDOFF.md에 기록                     │
│  - "무엇을 했고, 왜 했는지" 명시                      │
└─────────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────┐
│  3단계: 새 세션 시작 (Clear 효과)                    │
│  - 새 대화 시작 = Context 초기화                    │
│  - 또는 다른 에이전트(Gemini CLI/OpenAI)로 검증      │
└─────────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────┐
│  4단계: Verify (검증)                               │
│  - HANDOFF.md 읽고 코드 검토                        │
│  - 새로운 눈으로 버그/개선점 발견                    │
└─────────────────────────────────────────────────────┘
```

---

### 8.2 멀티 에이전트 + 피드백 루프 결합

다른 모델로 검증하면 Context Bias가 완전히 제거됨:

```python
class FeedbackLoopAgent:
    """
    멀티 에이전트 피드백 루프 시스템
    
    1. Antigravity (개발) - claude opus 4.5Gemini 기반
    2. Gemini CLI (1차 검증 - 새 세션)
    3. OpenAI (2차 검증 - 다른 모델)
    """
    
    def develop(self, task):
        """Antigravity가 개발"""
        code = antigravity.develop(task)
        self.save_handoff(task, code)
        return code
    
    def save_handoff(self, task, code):
        """의도 기록 (Boris 방식의 /handoff)"""
        with open("HANDOFF.md", "w") as f:
            f.write(f"## 작업: {task}\n")
            f.write(f"## 코드:\n```\n{code}\n```\n")
            f.write(f"## 의도: ...\n")
    
    def verify_round1(self, code):
        """Gemini CLI로 1차 검증 (새 세션 = Clear 효과)"""
        return gemini_cli.verify(code)
    
    def verify_round2(self, code):
        """OpenAI로 2차 검증 (다른 모델 = 더 독립적)"""
        return openai.verify(code)
    
    def full_workflow(self, task):
        """전체 피드백 루프"""
        # 1. 개발
        code = self.develop(task)
        
        # 2. 1차 검증 (Gemini - 새 세션)
        review1 = self.verify_round1(code)
        if not review1.passed:
            code = self.fix(code, review1.issues)
        
        # 3. 2차 검증 (OpenAI - 다른 모델)
        review2 = self.verify_round2(code)
        if not review2.passed:
            code = self.fix(code, review2.issues)
        
        return code
```

---

### 8.3 실제 Antigravity 사용 팁

1. **새 대화 시작 = /clear 효과**
   - 같은 세션에서 계속 작업하지 말고
   - 개발 완료 후 새 대화에서 검증 요청

2. **HANDOFF.md 작성**
   ```markdown
   ## 작업 내용
   - 무엇을 구현했는지
   
   ## 변경된 파일
   - file1.py: 어떤 변경
   - file2.py: 어떤 변경
   
   ## 의도
   - 왜 이렇게 구현했는지
   
   ## 검증 요청
   - 버그 있는지 확인해줘
   - 개선점 있는지 확인해줘
   ```

3. **다른 모델로 검증**
   - Antigravity 개발 → Gemini CLI 검증
   - 또는 Antigravity 개발 → OpenAI 검증
   - 다른 모델 = 완전히 다른 시각

---

## 9. GitHub 멀티 에이전트 관련 프로젝트

### 9.1 CLI Agent Orchestrator (CAO) - AWS Labs

**GitHub**: https://github.com/awslabs/cli-agent-orchestrator

AWS에서 만든 오픈소스 멀티 에이전트 오케스트레이터.

| 특징 | 설명 |
|------|------|
| **계층적 구조** | Supervisor Agent가 Worker Agent들에게 작업 위임 |
| **세션 격리** | 각 에이전트는 tmux 세션에서 독립 실행 |
| **MCP 서버** | 로컬 HTTP 서버로 에이전트 간 통신 |
| **프라이버시** | 모든 통신이 로컬에서 처리됨 |

**워크플로우 패턴:**
- `handoff`: 작업 전달
- `assign`: 작업 할당
- `send message`: 메시지 전송

---

### 9.2 Gemini CLI Extensions

**공식 문서**: https://geminicli.com

2025년 10월 출시된 Gemini CLI 확장 시스템.

```bash
# GitHub URL에서 확장 설치
gemini extension install https://github.com/user/my-extension

# 로컬 경로에서 설치
gemini extension install ./my-local-extension
```

**멀티 에이전트 명령어:**
- `/agents:start` - 에이전트 시작
- `/agents:run` - 에이전트 실행
- 각 확장이 하나의 에이전트 역할

---

### 9.3 Gemini CLI Orchestrator (MCP 서버)

오픈소스 MCP 서버로 Gemini와 외부 시스템 연결.

**기능:**
- 멀티 스텝 워크플로우 가이드
- 외부 도구/API 연결
- AI 에이전트 오케스트레이션

---

### 9.4 VS Code + GitHub Copilot Chat + MCP

2025년 11월 VS Code 업데이트로 추가된 기능.

| 기능 | 설명 |
|------|------|
| **GitHub MCP Server** | Copilot Chat 확장에 내장 |
| **다른 CLI 통합** | Gemini CLI, Claude CLI 연동 가능 |
| **인증 공유** | 기존 GitHub 인증 활용 |

---

### 9.5 Antigravity 공식 기능

**Google 공식 문서**: https://cloud.google.com/antigravity

| 기능 | 설명 |
|------|------|
| **Browser Subagent** | 브라우저 제어 에이전트 |
| **확장 설치** | 언어/도구 확장 지원 |
| **자율 에이전트** | 계획-실행-검증 자동화 |

> 💡 **Antigravity는 자체적으로 멀티 에이전트 플랫폼** - 별도 확장 없이도 `browser_subagent` 같은 서브에이전트 내장

---

## 10. 권장 구현 방법 (정리)

### 비용 효율적인 멀티 에이전트 구축

```
┌────────────────────────────────────────────────────────┐
│  1순위: Antigravity (현재 환경)                         │
│  - OAuth 인증으로 무료 할당량 사용                       │
│  - browser_subagent 등 내장 에이전트 활용               │
└────────────────────────────────────────────────────────┘
                      │
                      ▼
┌────────────────────────────────────────────────────────┐
│  2순위: Gemini CLI (새 세션으로 검증)                   │
│  - OAuth 인증으로 무료 할당량 사용                       │
│  - /agents 명령어로 멀티 에이전트 실행                   │
│  - 피드백 루프의 "Clear + Verify" 역할                  │
└────────────────────────────────────────────────────────┘
                      │
                      ▼
┌────────────────────────────────────────────────────────┐
│  3순위 (선택): CLI Agent Orchestrator                  │
│  - 더 복잡한 워크플로우가 필요할 때                      │
│  - MCP 서버로 에이전트 간 통신                          │
│  - tmux 세션 격리                                      │
└────────────────────────────────────────────────────────┘
```

### 체크리스트

- [ ] Antigravity 기본 사용법 숙지
- [ ] Gemini CLI 설치 및 OAuth 인증
- [ ] HANDOFF.md 템플릿 작성
- [ ] 피드백 루프 워크플로우 정립
- [ ] (선택) CAO 설치 및 테스트
