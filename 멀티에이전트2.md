# 멀티 에이전트 실전 구현 가이드

## 개요

이 문서는 Antigravity에서 멀티 에이전트 시스템을 **실제로 구현**하는 방법을 다룹니다.
이론적인 내용은 `멀티에이전트.md`를 참고하세요.

---

## 1. 프로젝트 구조 설계

### 1.1 권장 폴더 구조

```
프로젝트/
├── GEMINI.md              ← 🔥 Antigravity 자동 인식
├── CLAUDE.md              ← 🔥 Claude Code 자동 인식
├── README.md              ← 프로젝트 설명
├── .agent/
│   └── workflows/         ← 🔥 워크플로우 자동 인식
│       ├── develop.md
│       ├── review.md
│       └── deploy.md
├── skills/                ← 🔥 스킬 자동 인식
│   ├── excel-parser/
│   │   └── SKILL.md
│   ├── api-generator/
│   │   └── SKILL.md
│   └── code-reviewer/
│       └── SKILL.md
├── subagent/              ← 서브에이전트 프롬프트
│   ├── frontend-agent.md
│   ├── backend-agent.md
│   └── qa-agent.md
├── backend/
├── frontend/
├── scripts/
└── requirements.txt
```

---

## 2. 자동 인식 파일 상세

### 2.1 프로젝트 규칙 파일

| 파일명 | 에이전트 | 위치 | 자동 인식 |
|--------|----------|------|-----------|
| `GEMINI.md` | Gemini CLI / Antigravity | 프로젝트 루트 | ✅ |
| `CLAUDE.md` | Claude Code | 프로젝트 루트 | ✅ |
| `.cursorrules` | Cursor IDE | 프로젝트 루트 | ✅ |
| `AGENTS.md` | 일부 멀티에이전트 | 프로젝트 루트 | ✅ |
| `README.md` | 대부분 | 프로젝트 루트 | 참고용 |

### 2.2 GEMINI.md 작성 예시

```markdown
# 프로젝트 규칙

## 역할
너는 Excel 자동화 시스템을 개발하는 전문 에이전트야.

## 코딩 규칙
1. Python 3.11+ 사용
2. Type hints 필수
3. 한국어 주석 작성
4. pytest로 테스트 작성

## 폴더 구조
- backend/: FastAPI 백엔드
- frontend/: React 프론트엔드
- scripts/: 유틸리티 스크립트

## 금지 사항
- console.log 남기지 않기
- 하드코딩된 값 사용 금지
- 테스트 없이 커밋 금지

## 워크플로우
1. 항상 계획을 먼저 세워
2. 코드 작성 후 테스트
3. 검증 후 커밋
```

---

## 3. Skills 시스템

### 3.1 SKILL.md 형식

```markdown
---
description: 이 스킬이 하는 일 한 줄 설명
---

# 스킬 이름

## 목적
이 스킬이 해결하는 문제

## 사용 조건
- 언제 이 스킬을 사용해야 하는지
- 필요한 전제 조건

## 단계별 가이드
1. 첫 번째 단계
2. 두 번째 단계
3. 세 번째 단계

## 예시 코드
```python
# 예시 코드
```

## 주의사항
- 주의할 점들
```

### 3.2 스킬 예시: Excel Parser

**경로:** `skills/excel-parser/SKILL.md`

```markdown
---
description: Excel 파일을 파싱하여 JSON으로 변환
---

# Excel Parser Skill

## 목적
Excel 파일(.xlsx, .xls)을 읽어서 구조화된 JSON 데이터로 변환

## 사용 조건
- Excel 파일이 Data_Excel_file/ 폴더에 존재
- pandas 라이브러리 설치됨

## 단계별 가이드
1. Data_Excel_file/ 폴더에서 대상 파일 확인
2. pandas로 Excel 파일 읽기
3. 데이터 정제 및 변환
4. JSON 형식으로 반환

## 예시 코드
```python
import pandas as pd
from pathlib import Path

def parse_excel(file_path: str) -> dict:
    """Excel 파일을 파싱하여 딕셔너리로 반환"""
    df = pd.read_excel(file_path)
    
    # 빈 값 처리
    df = df.fillna("")
    
    # 딕셔너리로 변환
    return {
        "columns": df.columns.tolist(),
        "data": df.to_dict(orient="records"),
        "row_count": len(df)
    }
```

## 주의사항
- 대용량 파일(10만 행 이상)은 청크 단위로 처리
- 날짜 형식 자동 변환 주의
```

---

## 4. Workflows 시스템

### 4.1 워크플로우 파일 형식

**경로:** `.agent/workflows/워크플로우이름.md`

```markdown
---
description: 워크플로우 설명
---

# 워크플로우 이름

## 단계

1. 첫 번째 단계
   - 세부 내용

2. 두 번째 단계
   - 세부 내용

// turbo
3. 자동 실행할 단계 (터보 모드)
```

### 4.2 워크플로우 예시: 개발 워크플로우

**경로:** `.agent/workflows/develop.md`

```markdown
---
description: 기능 개발 워크플로우
---

# 개발 워크플로우

## 단계

1. **계획 수립**
   - 요구사항 분석
   - 기술 스택 결정
   - 파일 구조 계획

2. **코드 작성**
   - 핵심 로직 구현
   - 에러 처리 추가
   - 주석 작성

// turbo
3. **테스트 실행**
   - pytest 실행
   - 결과 확인

4. **검증** (새 세션 권장)
   - HANDOFF.md 작성
   - 새 대화에서 코드 리뷰 요청
```

### 4.3 워크플로우 호출 방법

```
/develop      → .agent/workflows/develop.md 실행
/review       → .agent/workflows/review.md 실행
/deploy       → .agent/workflows/deploy.md 실행
```

---

## 5. 병렬 처리 상세

### 5.1 도구 병렬 호출

**의존성 없는 작업은 동시 실행:**

```python
# 이 3개는 동시에 실행됨 (waitForPreviousTools=false)
view_file("file1.py")
view_file("file2.py")
view_file("file3.py")

# 이건 위 3개가 끝난 후 실행 (waitForPreviousTools=true)
replace_file_content(...)
```

**병렬 실행 가능한 작업:**
- 여러 파일 읽기
- 여러 검색 동시 실행
- 여러 이미지 생성
- 여러 URL 내용 읽기

**순차 실행 필요한 작업:**
- 같은 파일 편집
- 이전 결과에 의존하는 작업
- 파일 생성 후 편집

### 5.2 백그라운드 명령어

```python
# 서버를 백그라운드로 실행
run_command(
    CommandLine="npm run dev",
    Cwd="/project",
    WaitMsBeforeAsync=500,  # 0.5초 후 백그라운드로
    SafeToAutoRun=True
)
# → CommandId 반환

# 나중에 상태 확인
command_status(
    CommandId="xxx",
    WaitDurationSeconds=5,
    OutputCharacterCount=1000
)
```

**여러 프로세스 동시 실행:**
```
┌─────────────────────────────────────────────────────┐
│  프로세스 1: npm run dev (프론트엔드)               │
│  프로세스 2: uvicorn main:app (백엔드)              │
│  프로세스 3: pytest --watch (테스트)                │
└─────────────────────────────────────────────────────┘
         ↓
   각각 command_status로 모니터링
```

### 5.3 Browser Subagent

**브라우저 작업을 독립 에이전트에 위임:**

```python
browser_subagent(
    TaskName="쿠팡 상품 정보 수집",
    Task="""
    1. https://coupang.com/product/xxx 에 접속
    2. 상품명, 가격, 리뷰 수 추출
    3. 결과를 JSON 형식으로 반환
    
    반환 형식:
    {
        "name": "상품명",
        "price": 12345,
        "reviews": 100
    }
    """,
    RecordingName="coupang_scraping"
)
```

**동작 흐름:**
```
┌─────────────────────────────────────────────────────┐
│  메인 에이전트                                       │
│  - 전체 작업 조율                                   │
│  - browser_subagent 호출                            │
│  - 다른 작업 계속 진행 가능                          │
└─────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────┐
│  Browser Subagent (독립 실행)                       │
│  - 브라우저 열기                                    │
│  - 페이지 이동, 클릭, 타이핑                        │
│  - 데이터 추출                                      │
│  - 결과 반환                                        │
└─────────────────────────────────────────────────────┘
```

### 5.4 Boris 방식 병렬 개발 (Git Worktree)

```bash
# 메인 브랜치에서 독립 작업 공간 생성
git worktree add ../feature-auth -b feature/auth
git worktree add ../feature-api -b feature/api
git worktree add ../feature-ui -b feature/ui

# 각 터미널에서 독립 작업
# 터미널 1: cd ../feature-auth && claude code
# 터미널 2: cd ../feature-api && claude code
# 터미널 3: cd ../feature-ui && claude code
```

---

## 6. 피드백 루프 구현

### 6.1 HANDOFF.md 템플릿

개발 완료 후 검증을 위해 작성:

```markdown
# Handoff - [작업명]

## 작성일
2026-01-14

## 작업 내용
- 무엇을 구현했는지 설명

## 변경된 파일
- `backend/api/parser.py`: Excel 파싱 API 추가
- `backend/tests/test_parser.py`: 테스트 추가

## 주요 결정사항
- pandas 대신 openpyxl 사용 (메모리 효율)
- 청크 단위 처리 구현

## 의도
- 대용량 파일 처리 가능하도록 설계
- 메모리 사용량 최소화

## 검증 요청
1. 버그가 있는지 확인해주세요
2. 성능 개선 가능한 부분이 있는지 확인해주세요
3. 코드 스타일이 일관적인지 확인해주세요

## 테스트 방법
```bash
cd backend
pytest tests/test_parser.py -v
```
```

### 6.2 피드백 루프 워크플로우

```
┌─────────────────────────────────────────────────────┐
│  1단계: 개발                                        │
│  - Antigravity로 코드 작성                          │
│  - 테스트 작성                                      │
└─────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────┐
│  2단계: Handoff 작성                                │
│  - HANDOFF.md 생성                                  │
│  - 작업 내용, 의도, 검증 요청 명시                   │
└─────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────┐
│  3단계: 새 세션 시작 (Clear)                        │
│  - 새 대화 시작 = Context Bias 제거                 │
│  - 또는 Gemini CLI에서 검증                         │
└─────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────┐
│  4단계: 검증 (Verify)                               │
│  - "HANDOFF.md 읽고 코드 검토해줘"                  │
│  - 새로운 눈으로 버그/개선점 발견                    │
└─────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────┐
│  5단계: 수정 및 커밋                                │
│  - 피드백 반영                                      │
│  - 테스트 통과 확인                                 │
│  - Git 커밋                                         │
└─────────────────────────────────────────────────────┘
```

---

## 7. 실전 체크리스트

### 7.1 프로젝트 셋업

- [ ] GEMINI.md 생성 (프로젝트 규칙)
- [ ] .agent/workflows/ 폴더 생성
- [ ] skills/ 폴더 생성
- [ ] README.md 작성

### 7.2 스킬 정의

- [ ] 프로젝트에 필요한 스킬 목록 작성
- [ ] 각 스킬별 SKILL.md 생성
- [ ] 예시 코드 포함

### 7.3 워크플로우 정의

- [ ] develop.md (개발 워크플로우)
- [ ] review.md (검토 워크플로우)
- [ ] deploy.md (배포 워크플로우)

### 7.4 피드백 루프

- [ ] HANDOFF.md 템플릿 준비
- [ ] 검증 프로세스 정립
- [ ] (선택) Gemini CLI 설치

---

## 8. 다른 에이전트와 연동

### 8.1 Gemini CLI 연동

```bash
# 설치
npm install -g @google/gemini-cli

# OAuth 인증
gemini auth login

# 검증 요청
gemini chat "HANDOFF.md를 읽고 코드를 검토해줘"
```

### 8.2 Claude Code 연동

같은 프로젝트에서 CLAUDE.md도 작성해두면 두 에이전트 모두 사용 가능.

### 8.3 Python 오케스트레이터

```python
import subprocess

class MultiAgentOrchestrator:
    def __init__(self):
        self.agents = {
            "gemini": "gemini chat",
            "claude": "claude code"
        }
    
    def call_agent(self, agent_name: str, prompt: str) -> str:
        cmd = f'{self.agents[agent_name]} "{prompt}"'
        result = subprocess.run(cmd, shell=True, capture_output=True, text=True)
        return result.stdout
    
    def verify_with_different_agent(self, code: str) -> str:
        """다른 에이전트로 코드 검증"""
        return self.call_agent("gemini", f"이 코드를 검토해줘:\n{code}")
```

---

## 9. 문서 비교

| 항목 | 멀티에이전트.md | 멀티에이전트2.md (이 문서) |
|------|----------------|-------------------------|
| **초점** | 이론, 연구 결과 | 실전 구현 |
| **API 과금** | 무료 할당량 활용법 | - |
| **프레임워크** | LangGraph, AutoGen, CrewAI 비교 | - |
| **Boris 방식** | 개념 설명 | 실제 구현 방법 |
| **폴더 구조** | 간단한 예시 | 상세 템플릿 |
| **SKILL.md** | 언급만 | 상세 작성법 |
| **워크플로우** | 개념 | 상세 작성법 |
| **병렬 처리** | 간단 언급 | 상세 설명 |
| **피드백 루프** | 개념 | 실전 템플릿 |
| **GitHub 프로젝트** | CAO, Gemini CLI 등 | - |

---

## 10. 요약

**이 문서를 읽고 할 수 있는 것:**

1. ✅ 프로젝트 폴더 구조 설계
2. ✅ GEMINI.md 작성
3. ✅ SKILL.md 작성
4. ✅ 워크플로우 정의
5. ✅ 병렬 처리 활용
6. ✅ 피드백 루프 구현
7. ✅ 다른 에이전트와 연동
